---
interface Props {
  action?: string;
}
const { action = 'https://api.web3forms.com/submit' } = Astro.props as Props;
---
<form method="POST" id="signup-form" action={action} class="w-full rounded-xl bg-gray-800 bg-opacity-70 p-6 shadow-lg text-white">
  <input type="hidden" name="subject" value="New Signup from website" />
  <input type="hidden" name="access_key" value={import.meta.env.PUBLIC_WEB3FORMS_KEY ?? ''} />
  <div class="grid gap-4">
    <h3>Sign Up to my mailing list :)</h3>
    <label class="text-sm font-semibold">Name <span class="text-xs text-gray-400">(Required)</span></label>
    <input type="text" name="name" placeholder="Your full name" required class="w-full p-3 rounded-md bg-gray-700 bg-opacity-50 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" />
    <label class="text-sm font-semibold">Email Address <span class="text-xs text-gray-400">(Required)</span></label>
    <input type="email" name="email" placeholder="name@email.com" required class="w-full p-3 rounded-md bg-gray-700 bg-opacity-50 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder:text-gray-400" />

    <!-- <label class="text-sm font-semibold">Phone Number <span class="text-xs text-gray-400">(Required)</span></label>
    <div class="flex gap-2 items-center">
      <select name="country" aria-label="Country" class="p-3 rounded-md bg-gray-700 bg-opacity-50">
        <option value="uk">ðŸ‡¬ðŸ‡§ +44</option>
        <option value="us">ðŸ‡ºðŸ‡¸ +1</option>
      </select>
      <input type="tel" name="phone" placeholder="+44 7123 456789" required class="flex-1 p-3 rounded-md bg-gray-700 bg-opacity-50 focus:outline-none" />
    </div> -->

    <label class="text-sm font-semibold">Message</label>
    <textarea name="message" placeholder="Leave your message" rows="3" class="w-full p-3 rounded-md bg-gray-700 bg-opacity-50 focus:outline-none"></textarea>

    <button type="submit" class="mt-2 w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold p-3 rounded-lg">Sign Up</button>
    <p class="text-xs text-gray-400 mt-2">By submitting my info, I consent to receive recurring automated marketing messages. Reply STOP to cancel. MSG will be sent to your number. See Terms and Privacy.</p>
  </div>
    <p id="signup-success" class="hidden text-sm mt-2 text-green-400">Thanks! Check your email for confirmation.</p>
    <p id="signup-error" class="hidden text-sm mt-2 text-red-400">There was an error with the signup. Please try again.</p>
  </div>

  <script type="module">
  const form = document.getElementById('signup-form');
  const success = document.getElementById('signup-success');
  const error = document.getElementById('signup-error');
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;

  const FALLBACK_WEB3FORMS = 'https://api.web3forms.com/submit';
  const PUBLIC_KEY = import.meta.env.PUBLIC_WEB3FORMS_KEY ?? '';

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    success?.classList.add('hidden');
    error?.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    const data = new FormData(form);

    try {
      console.log('Signup form: action=', form.action);
      let res = null;

      // Try serverless endpoint first
      try {
        console.log('Attempting serverless POST to', form.action);
        res = await fetch(form.action, { method: 'POST', body: data });
        console.log('Serverless response', res.status);
      } catch (err) {
        console.warn('Serverless POST failed (possible 404 or CORS):', err);
        res = null;
      }

      // If no response or 404, and we have a PUBLIC KEY fallback, try web3forms
      if ((res === null || res.status === 404) && PUBLIC_KEY) {
        console.log('Falling back to web3forms via PUBLIC key (client-side). Not recommended for production where serverless is supported.');
        // Set name if first/last exist
        const firstName = data.get('firstName')?.toString() ?? '';
        const lastName = data.get('lastName')?.toString() ?? '';
        if (firstName || lastName) {
          const combined = `${firstName}${firstName && lastName ? ' ' : ''}${lastName}`.trim();
          data.set('name', combined);
        }
        data.set('access_key', PUBLIC_KEY);
        res = await fetch(FALLBACK_WEB3FORMS, { method: 'POST', body: data });
      }

      if (!res) throw new Error('No response from server (and no fallback configured)');
      console.log('Final response status', res.status);
      if (res.status === 404) {
        console.error('Signup route not found (404).');
        error?.classList.remove('hidden');
        return;
      }

      const json = await res.json();
      console.log('Response JSON:', json);
      if (res.ok) {
        success?.classList.remove('hidden');
        form.reset();
      } else {
        console.error('Signup failed', json);
        error?.classList.remove('hidden');
      }
    } catch (err) {
      console.error('Signup error', err);
      error?.classList.remove('hidden');
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });

  </script>
</form>
